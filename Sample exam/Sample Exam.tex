\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{enumitem}
\usepackage{listings}
\usepackage{pdfpages}
\usepackage{comment}
\usepackage{mathpartir}
\usepackage[top=2cm, bottom=3cm, left=1.5cm, right=1.5cm]{geometry}

\newcommand{\tu}{\textunderscore}

\lstset{
  language=sql,
	tabsize=2,
	basicstyle=\small\ttfamily,
	columns=fixed,
	showstringspaces=false,
	breaklines=true,
	showtabs=false,
	showspaces=false,
	showstringspaces=false,
}

\newcommand{\courseCode}{Development - Databases}
%\newcommand{\git}{ \texttt{Dev81718First} }

\newcounter{ExerciseCount}
\setcounter{ExerciseCount}{1}

\newcommand{\functionEx}[3]{
  Implement a function
  
  \vspace{0.15cm}
  \texttt{let #1 #2 = ...}
   
   \vspace{0.15cm}
   #3
}
\newcommand{\emptyPlace}{\tu\tu\tu}
\newcommand{\exercise}[2]{\noindent \textbf{Exercise \theExerciseCount \space - (#2 points):}
  
  \vspace{0.15cm}
  \noindent
 #1 \addtocounter{ExerciseCount}{1}
}

\title{\courseCode}
\date {  }


\begin{document}
%\includepdf{Cover/first}
\maketitle

\huge
\textbf{Database definition for the exam}
\normalsize


\begin{lstlisting}[frame=single]
create table "User" (
	"Id" integer primary key,
	"Email" varchar(30) unique,
	"Username" varchar(30) unique,
	"Balance" real check ("Balance" > 0),
	"CreditCardNo" char(16)
);

create table "Game" (
	"Title" varchar(50),
	"Year" integer,
  "Released" boolean,
	"Price" real check ("Price" > 0),
	"PEGI" integer check ("PEGI" > 0),
	primary key("Title", "Year")
);

create table "User_Game" (
	"UserId" integer,
	"Title" varchar(50),
	"Year" integer,
  primary key ("UserId", "Title", "Year"),
  foreign key ("UserId") references "User" on delete cascade,
  foreign key ("Title", "Year") references "Game" on delete cascade
);

create table "Review"  (
  "UserId" integer not null references "User" on delete cascade,
  "Title" varchar(50),
  "Text" text,
  "Score" smallint check ("Score" between 0 and 10),
  "GameTitle" varchar(50) not null,
  "GameYear" integer not null,
  "Date" timestamp without time zone, 
  primary key ("UserId", "Title"),
  foreign key ("GameTitle","GameYear") references "Game"
);
\end{lstlisting}

\noindent
\textbf{Note:} The PEGI index marks the minimum suggested age to sold that particular game, so for example \texttt{PEGI = 16} means that the game should be sold only to people who are 16 or older.

\newpage

\exercise{
  \noindent
  Write a query that adds the following table \texttt{Publisher} to the database:
    \begin{table}[!h]
      \centering
      \begin{tabular}{|c|c|}
        \hline
        \textbf{Column} & \textbf{Type}\\
        \hline
        \texttt{Id} & \texttt{integer}\\
        \hline
        \texttt{Name} & \texttt{varchar(20)}\\
        \hline
        \texttt{Founded} & \texttt{integer}\\
        \hline
      \end{tabular}
    \end{table}
    and the following constraints:
    \begin{itemize}[noitemsep]
    \item The primary key is \texttt{Id}.
    \item \texttt{Name} cannot be \texttt{NULL}.
    \item \texttt{Founded} must be greater than \texttt{1970}. 
    \end{itemize}
}{5}

\vspace{0.5cm}
\exercise{
Assuming of having performed the change of schema in the previous question, define a reference between \texttt{Producer} and \texttt{Game}, such that a producer can publish different games but a game can only be published by one producer.
}{5}

\vspace{0.5cm}
\exercise{
Assume of having performed the change of schema in Exercise 1, add the necessary entries in the database to insert the game \texttt{Call of Duty: Modern Warfare}, that will be published in November 2019 and produced by \texttt{Activision} founded in \texttt{1970}. Activision suggests that the game is sold to people who are 16 or older. You can choose an \texttt{Id} of your choice for the new row in the table \texttt{Publisher}.
}{10}

\vspace{0.5cm}
\exercise{
Write a query that retrieves the title and price of all games released after 2010. Eliminate duplicate rows from the result.
}{10}

\vspace{0.5cm}
\exercise{
Write a query that returns the title and price of all the games owned by user \texttt{pureownage}.
}{15}

\vspace{0.5cm}
\exercise{
Write a query that returns, for each user, his username and the average score of the games he reviewed.
}{15}

\vspace{0.5cm}
\exercise{
Write a query that returns the title and price of the game with the highest average review score.
}{20}

\vspace{0.5cm}
\exercise{
Write a query that returns all the column values of the top-selling game of 2019. The top-selling game is the game with the highest revenue (calculated as the sum of all purchased copies).
}{20}
\end{document}